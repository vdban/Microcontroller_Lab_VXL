/*
 * fsm.c
 *
 *  Created on: Nov 27, 2025
 *      Author: ACER
 */
#include "fsm.h"
#include "software_timer.h"
#include <stdio.h>

extern ADC_HandleTypeDef hadc1;
extern UART_HandleTypeDef huart2;

int status = 0;

void command_parser_fsm() {
	if (temp == '#') {
		if (buffer[0] == '!' && buffer[1] == 'R' && buffer[2] == 'S' && buffer[3] == 'T') {
			command_flag = 1;
		}
		if (buffer[0] == '!' && buffer[1] == 'O' && buffer[2] == 'K') {
			command_flag = 2;
		}
		index_buffer = 0;
	}
}

void uart_communiation_fsm() {
	char str[30];
	switch (status) {
	case 0: // IDLE
	        if (command_flag == 1) {
	            command_flag = 0;
	            status = 1;
	        }
	        break;

	    case 1: // SEND
	        ADC_value = HAL_ADC_GetValue(&hadc1);
	        sprintf(str, "!ADC=%ld#\r\n", ADC_value);
	        HAL_UART_Transmit(&huart2, (uint8_t*)str, 30, 1000);

	        status = 2;
	        last_time = HAL_GetTick(); // Lưu thời điểm hiện tại (Thay cho setTimer)
	        break;

	    case 2: // WAIT
	        if (command_flag == 2) {
	            status = 0;
	            command_flag = 0;
	        }
	        // Kiểm tra xem đã qua 3000ms chưa (Thay cho timer1_flag)
	        else if (HAL_GetTick() - last_time >= 3000) {
	            status = 1; // Quay lại gửi tiếp
	        }
	        break;
	default:
		status = 0;
		break;
	}
}

